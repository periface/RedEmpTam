var Engine=function(n){function i(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}function l(){return i()+i()+"-"+i()+"-"+i()+"-"+i()+"-"+i()+i()+i()}function r(n,t,i){for(var r=0;r<n.length;r++)if(n[r][t]===i)return n[r];return undefined}function a(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);return n}function o(n){return n.substring(n.indexOf(".")+1)}function s(i){var o=i.split("."),f,e;for(n.enableDebug&&console.info("Resolving service by convention"),f=0;f<o.length;f++)if(e=r(t.propertyServices,u,o[f]),e!=undefined)return f>0?(console.warn("Warning: The service "+e.propertyServiceName+" was resolved in position "+f),undefined):e;return undefined}var f,e,h;n||(console.warn("Options r null loading defaults..."),n={useOverlay:!0,autoStart:!1,overlayObj:undefined,enableDebug:!1,onAllRequestsFinished:undefined,resolveByConvention:!1});var t=this,u="propertyServiceName",c="iterationServiceName";return this.propertyServices=[],this.iterationServices=[],f=function(n,t,i,r){var u=l();this.templateId="template-"+u;this.mainContext=i;this.parentContext=t;this.iterationTemplate=n;this.iterationTemplate.attr("data-templateId",this.templateId);this.parentContextId=$(t).data("iterate");this.mainContextId=u;this.iterationTemplateName=$(n).data("template");this.isIterationContextInsideMainContext=r},this.defineIterationService=function(n,i){t.iterationServices.push({iterationServiceName:n,iterationServiceEndPoint:i})},this.definePropertyService=function(n,i){t.propertyServices.push({propertyServiceName:n,propertyServiceEndPoint:i})},e=function(n,t,i,r,u,f,e,o,s,h){this.propertyRequest=n;this.propertyServiceName=t;this.printInProperty=i;this.replicate=r;this.callbackFunc=u;this.runAsync=o;this.useFuncOnly=f;this.requestProperties=e;this.element=s;this.iterationObjName=h},this.lookForChilds=function(n){setTimeout(function(){var i=$(n[0]).find("[data-iterate]");i.length>0&&$.each(i,function(n,i){var u=$(i),h=$(i).parentsUntil("[data-parent]").parent().closest("[data-parent]"),r=$(i).children().closest("[data-template]"),e=!0,o,s;r.length<=0&&(o=u.data("iterate"),r=$("body").children().closest("[data-template='"+o+"']"),e=!1);s=new f(r,h,u,e);t.processContext(s,t.deferred)})})},this.processContext=function(i,u){setTimeout(function(){var e;if(i){n.enableDebug&&(console.log("Processing context ->"),console.log(i));var o=i.mainContext.data("iterate"),s=i.mainContext.data("source"),h=i.mainContext.data("beforesend"),f=r(t.iterationServices,c,s);f==undefined?console.error("Iteration service undefined for "+s):(e=i.parentContext.data("iterationfinished"),e===!0?t.buildAjaxIObj(i,f.iterationServiceEndPoint,u,o,h):e==undefined&&i.parentContext.length<=0&&t.buildAjaxIObj(i,f.iterationServiceEndPoint,u,o,h))}},0)},this.deferred=[],this.listener=function(){function i(){$("[data-property]").each(function(i,f){var y=$(f),h=$(f).data("property"),a=$(f).data("servicename"),p=$(f).data("printproperty"),w=$(f).data("replicate"),b=$(f).data("callback"),k=$(f).data("ignoreall"),d=$(f).data("params"),g=$(f).data("before"),nt=$(f).data("after"),v=$(f).data("async"),c,l;v==undefined&&(v=!0);c=new e(h,a,p,w,b,k,d,v,y);c.before=g;c.after=nt;n.resolveByConvention?(l=s(h),l==undefined?(n.enableDebug&&console.warn("Resolve by convention failed for property "+h+" trying to resolve the service by default"),l=r(t.propertyServices,u,a)):(n.enableDebug&&console.warn("Resolve by convention succeded for property "+h),c.propertyRequest=o(c.propertyRequest))):l=r(t.propertyServices,u,a);l==undefined?(console.warn("Service undefined for property "+h),n.enableDebug&&console.info("Trying to get the service by convention for property "+h),l=s(h),l==undefined?(console.warn("Second try : Service undefined for property "+h),console.info("Seems like you have the convention resolver inactive and you dont have a data-servicename defined for this property ("+h+"), skipping.....")):(console.info("The convention resolver fixed the problem, but please check the code or enable the convention resolver in the options object"),c.propertyRequest=o(c.propertyRequest),t.buildAjaxObj(l.propertyServiceEndPoint,c,t.deferred))):t.buildAjaxObj(l.propertyServiceEndPoint,c,t.deferred)})}function h(){$("[data-iterate]").each(function(n,i){var u=!0,e=$(i),r=$(i).children().closest("[data-template]"),o,s,h;r.length<=0&&(o=e.data("iterate"),r=$("body").children().closest("[data-template='"+o+"']"),u=!1);s=$(i).parentsUntil("[data-parent]").parent().closest("[data-parent]");h=new f(r,s,e,u);t.processContext(h,t.deferred)})}i();h();$.when.apply($,t.deferred).done(t.allDoneFunction)},n.autoStart&&t.listener(),h=function(n){return Object.assign(n)},this.buildAjaxIObj=function(n,i,r,u,f){var e={};(n!==""||n!=undefined||n!==null)&&i!==""&&r.push($.ajax({url:i,data:e,beforeSend:function(i,r){f!=undefined&&t.callFunction(f,e,n,function(n){n&&(r.url=r.url+"/"+n.Id)})},statusCode:{500:function(){console.log("500 error on context");console.log(n);console.log("Iterate value"+u)}},error:function(){console.warn("Endpoint ("+i+") failed");return}}).done(function(i){var r=[];$.each(i,function(n,t){r.push(new h(t))});t.processTemplate(n,r,u);n.mainContext.attr("data-iterationfinished",!0);t.lookForChilds(n.mainContext,!0)}))},this.processTemplate=function(n,i,r){var u=n.iterationTemplate,f,o;console.log(n);console.log(u);console.log(i);console.log(r);f=u.html();u.html("");u.append("<!--IterationContext for "+r+"-->");$.each(i,function(n){var t="<div data-itid='"+r+"' data-identifier="+n+">";t+=f;t+="<\/div>";u.append(t)});o=u.find("[data-identifier]");o.each(function(n,u){var f=$(u).data("identifier"),o=$(u).find("[data-iproperty]");o.each(function(n,u){var s=$(u).data("iproperty"),h=$(u).data("printproperty"),c=$(u).data("replicate"),l=$(u).data("callback"),a=$(u).data("ignoreall"),v=$(u).data("before"),y=$(u).data("after"),p=t.resolvePropertyValue(s,i[f]),w=$(u),o=new e(s,"",h,c,l,a,undefined,!0,w,r);o.before=v;o.after=y;t.bindDataOfIteration(o,p)})});u.append("<!--End of IterationContext for"+r+"-->")},this.bindDataOfIteration=function(n,i){n.callbackFunc?n.useFuncOnly?t.callFunction(n.callbackFunc,i,n.element):(t.bindData(n,i),t.callFunction(n.callbackFunc,i,n.element)):t.bindData(n,i)},this.resolvePropertyValue=function(t,i){var r;n.enableDebug&&console.log("Trying to resolve "+t+" from object -->");for(r in i)if(Object.prototype.hasOwnProperty.call(i,r)&&t===r)return i[r]},this.buildAjaxObj=function(n,i,r){if(n!==""&&i.propertyRequest!==""){var u=t.resolveDataRequest(i.propertyRequest,i.requestProperties);r.push($.ajax({url:n,data:u,async:i.runAsync}).done(function(n){i.callbackFunc?i.useFuncOnly?t.callFunction(i.callbackFunc,n,i.element):(t.bindData(i,u),t.callFunction(i.callbackFunc,n,i.element)):t.bindData(i,n)}))}},this.callFunction=function(n,t,i,r){try{window[n](t,i,function(n){r(n)})}catch(u){console.warn("Callback function has failed to execute or has some internal errors, please check it out --->");console.log("----------------------------------");console.log(u);console.log("----------------------------------");console.info("Dont try to eval the function in the lib source dude... pls -->");console.info("Lets continue....");return}},this.allDoneFunction=function(){n.onAllRequestsFinished?(n.onAllRequestsFinished(),n.useOverlay&&t.hideOverlay()):(n.useOverlay&&t.hideOverlay(),console.log("All requests done"))},this.hideOverlay=function(){n.overlayObj?document.getElementById(n.overlayObj).style.width="0%":console.warn("No overlay defined")},this.bindData=function(n,i){var u,r;if(n.printInProperty){for(u=n.printInProperty.split(","),r=0;r<u.length;r++)n.element.attr(u[r],i);n.replicate?t.appendDataInDomElement(n,i):t.appendOnlyId(n)}else t.appendDataInDomElement(n,i)},this.appendDataInDomElement=function(n,t){n.before&&(t=n.before+" "+t);n.after&&(t=t+" "+n.after);n.element.text(t);n.element.attr("id",n.propertyRequest);n.element.attr("data-property-finished",!0)},this.appendOnlyId=function(n){n.element.attr("id",n.propertyRequest);n.element.attr("data-property-finished",!0)},this.getValueFromDomElement=function(n){var t=document.getElementById(n).value;return t?t:undefined},this.getValue=function(n,i,f,e){var o=r(t.propertyServices,u,n);o==undefined?console.error("Service undefined"):t.getValueFromService(o,i,f,function(n){e(n)})},this.getValueFromService=function(n,i,r,u){var f=t.resolveDataRequest(i,r);$.ajax({url:n.propertyServiceEndPoint,data:f,success:function(n){u(n)}})},this.resolveDataRequest=function(t,i){var u={key:t},r;return i!=undefined?(r=a(u,i),n.enableDebug&&(console.info("The request object has been extended --->"),console.log(r)),r):u},{propertyServices:this.propertyServices,defineNewPropertyService:this.definePropertyService,defineIterationSericePoint:this.defineIterationService,getValueFromDom:this.getValueFromDomElement,startListener:this.listener,getValue:this.getValue}};