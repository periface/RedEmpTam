var Engine=function(n){function i(n,t,i){for(var r=0;r<n.length;r++)if(n[r][t]===i)return n[r];return undefined}function h(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);return n}function e(n){return n.substring(n.indexOf(".")+1)}function o(u){var o=u.split("."),f,e;for(n.enableDebug&&console.info("Resolving service by convention"),f=0;f<o.length;f++)if(e=i(t.propertyServices,r,o[f]),e!=undefined)return f>0?(console.warn("Warning: The service "+e.propertyServiceName+" was resolved in position "+f),undefined):e;return undefined}var u,s;n||(console.warn("Options r null loading defaults..."),n={useOverlay:!0,autoStart:!1,overlayObj:undefined,enableDebug:!1,onAllRequestsFinished:undefined,resolveByConvention:!1});var t=this,r="propertyServiceName",f="iterationServiceName";return this.propertyServices=[],this.dependentIterations=[],this.iterationServices=[],this.defineIterationService=function(n,i){t.iterationServices.push({iterationServiceName:n,iterationServiceEndPoint:i})},this.definePropertyService=function(n,i){t.propertyServices.push({propertyServiceName:n,propertyServiceEndPoint:i})},u=function(n,t,i,r,u,f,e,o,s){this.propertyRequest=n;this.propertyServiceName=t;this.printInProperty=i;this.replicate=r;this.callbackFunc=u;this.runAsync=o;this.useFuncOnly=f;this.requestProperties=e;this.element=s},this.executeInQueue=function(n){$.each(t.dependentIterations,function(t,i){var o;if(i.dependsOn===n&&!i.executed){var u=$('[data-template="'+i.dependsOn+'"]'),f=$(u).find('[data-identifier="'+i.sectionId+'"]'),r=$(f).find('[data-iterate="'+i.iterationName+'"]'),e=$(r[0])[0];console.log($(e).find("data-id"));o=$(r).data("data-id");i.executed=!0}})},this.setSectionIdToQueueElement=function(n,i){$.each(t.dependentIterations,function(t,r){r.dependsOn===i&&(r.sectionId||(r.sectionId=n))})},this.listener=function(){function h(){$("[data-property]").each(function(){var v=$(this),f=$(this).data("property"),l=$(this).data("servicename"),y=$(this).data("printproperty"),p=$(this).data("replicate"),w=$(this).data("callback"),b=$(this).data("ignoreall"),k=$(this).data("params"),a=$(this).data("async"),c,h;a==undefined&&(a=!0);c=new u(f,l,y,p,w,b,k,a,v);n.resolveByConvention?(h=o(f),h==undefined?(n.enableDebug&&console.warn("Resolve by convention failed for property "+f+" trying to resolve the service by default"),h=i(t.propertyServices,r,l)):(n.enableDebug&&console.warn("Resolve by convention succeded for property "+f),c.propertyRequest=e(c.propertyRequest))):h=i(t.propertyServices,r,l);h==undefined?(console.warn("Service undefined for property "+f),n.enableDebug&&console.info("Trying to get the service by convention for property "+f),h=o(f),h==undefined?(console.warn("Second try : Service undefined for property "+f),console.info("Seems like you have the convention resolver inactive and you dont have a data-servicename defined for this property ("+f+"), skipping.....")):(console.info("The convention resolver fixed the problem, but please check the code or enable the convention resolver in the options object"),c.propertyRequest=e(c.propertyRequest),t.buildAjaxObj(h.propertyServiceEndPoint,c,s))):t.buildAjaxObj(h.propertyServiceEndPoint,c,s)})}function c(){$("[data-iterate]").each(function(){var n=this,c=$(n).parents("[data-iterate]").length===1,r,h;if(c)r=$(n).parents("[data-iterate]")[0],t.dependentIterations.push({dependsOn:$(r).data("iterate"),executed:!1,iterationSourceName:$(this).data("source"),beforeSendFunction:$(this).data("beforesend"),iterationService:i(t.iterationServices,f,$(this).data("source")),iterationName:$(n).data("iterate")});else{var u=$(this).data("iterate"),e=$(this).data("source"),l=$(this).data("beforesend"),o=i(t.iterationServices,f,e);o==undefined?console.error("Iteration service undefined for "+e):(h=$('[data-template="'+u+'"]'),t.buildAjaxIObj(h,o.iterationServiceEndPoint,s,u,l))}})}var s=[];h();c();$.when.apply($,s).done(t.allDoneFunction)},n.autoStart&&t.listener(),s=function(n){return Object.assign(n)},this.buildAjaxIObj=function(n,i,r,u,f){var e={};i!==""&&(f!=undefined,r.push($.ajax({url:i,data:e,beforeSend:function(i,r){f!=undefined&&t.callFunction(f,e,n,function(n){n&&(r.url=r.url+"/"+n.Id)})},success:function(i){var r=[];$.each(i,function(n,t){r.push(new s(t))});t.processTemplate(n,r,u)},error:function(){console.warn("Endpoint ("+i+") failed");return}})))},this.processTemplate=function(n,i,r){var e=n.html(),f;n.html("");n.append("<!--IterationContext for "+r+"-->");$.each(i,function(t){var i="<div data-identifier="+t+">";i+=e;i+="<\/div>";n.append(i)});f=$(n).find("[data-identifier]");f.each(function(n,f){var e=$(f).data("identifier"),o;t.setSectionIdToQueueElement(e,r);o=$(f).find("[data-iproperty]");o.each(function(n,f){var o=$(f).data("iproperty"),h=$(f).data("printproperty"),c=$(f).data("replicate"),l=$(f).data("callback"),a=$(f).data("ignoreall"),v=t.resolvePropertyValue(o,i[e]),y=$(f),s=new u(o,"",h,c,l,a,undefined,!0,y);s.iterationObjName=r;t.bindDataOfIteration(s,v)})});n.append("<!--End of IterationContext for"+r+"-->")},this.bindDataOfIteration=function(n,i){n.callbackFunc?n.useFuncOnly?t.callFunction(n.callbackFunc,i,n.element):(t.bindData(n,i),t.callFunction(n.callbackFunc,i,n.element)):t.bindData(n,i)},this.resolvePropertyValue=function(n,t){var i;console.log("Trying to resolve "+n+" from object -->");for(i in t)if(Object.prototype.hasOwnProperty.call(t,i)&&n===i)return t[i]},this.buildAjaxObj=function(n,i,r){if(n!==""&&i.propertyRequest!==""){var u=t.resolveDataRequest(i.propertyRequest,i.requestProperties);r.push($.ajax({url:n,data:u,async:i.runAsync,success:function(n){i.callbackFunc?i.useFuncOnly?t.callFunction(i.callbackFunc,n,i.element):(t.bindData(i,u),t.callFunction(i.callbackFunc,n,i.element)):t.bindData(i,n)}}))}},this.callFunction=function(n,t,i,r){try{window[n](t,i,function(n){r(n)})}catch(u){console.warn("Callback function has failed to execute or has some internal errors, please check it out --->");console.log("----------------------------------");console.log(u);console.log("----------------------------------");console.info("Dont try to eval the function in the lib source dude... pls -->");console.info("Lets continue....");return}},this.allDoneFunction=function(){n.onAllRequestsFinished?(n.onAllRequestsFinished(),n.useOverlay&&t.hideOverlay()):(n.useOverlay&&t.hideOverlay(),console.log("All requests done"))},this.hideOverlay=function(){n.overlayObj?document.getElementById(n.overlayObj).style.width="0%":console.warn("No overlay defined")},this.bindData=function(n,i){n.printInProperty?(n.element.attr(n.printInProperty,i),n.replicate?t.appendDataInDomElement(n,i):t.appendOnlyId(n)):t.appendDataInDomElement(n,i)},this.appendDataInDomElement=function(n,i){n.element.text(i);n.element.attr("id",n.propertyRequest);n.element.attr("data-finished",!0);t.executeInQueue(n.iterationObjName)},this.appendOnlyId=function(n){n.element.attr("id",n.propertyRequest);n.element.attr("data-finished",!0);t.executeInQueue(n.iterationObjName)},this.getValueFromDomElement=function(n){var t=document.getElementById(n).value;return t?t:undefined},this.getValue=function(n,u,f,e){var o=i(t.propertyServices,r,n);o==undefined?console.error("Service undefined"):t.getValueFromService(o,u,f,function(n){e(n)})},this.getValueFromService=function(n,i,r,u){var f=t.resolveDataRequest(i,r);$.ajax({url:n.propertyServiceEndPoint,data:f,success:function(n){u(n)}})},this.resolveDataRequest=function(t,i){var u={key:t},r;return i!=undefined?(r=h(u,i),n.enableDebug&&(console.info("The request object has been extended --->"),console.log(r)),r):u},{propertyServices:this.propertyServices,defineNewPropertyService:this.definePropertyService,defineIterationSericePoint:this.defineIterationService,getValueFromDom:this.getValueFromDomElement,startListener:this.listener,getValue:this.getValue}};