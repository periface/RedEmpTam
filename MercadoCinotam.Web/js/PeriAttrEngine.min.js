var Engine=function(n){function i(n,t,i){for(var r=0;r<n.length;r++)if(n[r][t]===i)return n[r];return undefined}function h(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);return n}function e(n){return n.substring(n.indexOf(".")+1)}function o(u){var o=u.split("."),f,e;for(n.enableDebug&&console.info("Resolving service by convention"),f=0;f<o.length;f++)if(e=i(t.propertyServices,r,o[f]),e!=undefined)return f>0?(console.warn("Warning: The service "+e.propertyServiceName+" was resolved in position "+f),undefined):e;return undefined}var u,f;n||(console.warn("Options r null loading defaults..."),n={useOverlay:!0,autoStart:!1,overlayObj:undefined,enableDebug:!1,onAllRequestsFinished:undefined,resolveByConvention:!1});var t=this,r="propertyServiceName",s="iterationServiceName";return this.propertyServices=[],this.dependentIterations=[],this.iterationServices=[],this.jobsFinished=[],this.addJobsFinished=function(n){t.jobsFinished.push(n)},this.defineIterationService=function(n,i){t.iterationServices.push({iterationServiceName:n,iterationServiceEndPoint:i})},this.definePropertyService=function(n,i){t.propertyServices.push({propertyServiceName:n,propertyServiceEndPoint:i})},u=function(n,t,i,r,u,f,e,o,s,h){this.propertyRequest=n;this.propertyServiceName=t;this.printInProperty=i;this.replicate=r;this.callbackFunc=u;this.runAsync=o;this.useFuncOnly=f;this.requestProperties=e;this.element=s;this.iterationObjName=h},this.executeInQueue=function(n){$.each(t.dependentIterations,function(i,r){r.dependsOn===n&&(r.executed||(setTimeout(function(){var o;console.log("dependen of section id "+r.sectionId);var n=$('[data-template="'+r.dependsOn+'"]'),i=$(n).find('[data-identifier="'+r.sectionId+'"]'),u=$(i).find('[data-iterate="'+r.iterationName+'"]'),f=$(u[0])[0],e=$('[data-template="'+r.iterationName+'"]');t.buildAjaxIObj(e,r.iterationService.iterationServiceEndPoint,r.deferredReference,r.iterationName,r.beforeSendFunction);o=$(f).data("id")},0),r.executed=!0))})},this.setSectionIdToQueueElement=function(n,i){$.each(t.dependentIterations,function(t,r){r.dependsOn===i&&(r.sectionId||(r.sectionId=n))})},this.lookForChilds=function(n){console.log("Now looking for childs inside context -->");var i=$(n[0]).find("[data-iterate]");i.length>0?(console.log("The context has "+i.length+" childs"),$.each(i,function(n,i){console.log(i);t.processContext(i,t.deferred,!0,!1)})):console.log("No childs")},this.processContext=function(n,r,u,f){var o=$(n).parentsUntil("[data-iterate]"),e;console.log(o);e=!1;u&&(e=f?!0:!1);setTimeout(function(){var c;if(n){console.log("Processing context ->");console.log(n);var f=$(n).data("iterate"),o=$(n).data("source"),l=$(n).data("beforesend"),h=i(t.iterationServices,s,o);h==undefined?console.error("Iteration service undefined for "+o):(c=$(n).find('[data-template="'+f+'"]'),t.buildAjaxIObj(c,h.iterationServiceEndPoint,r,f,l,e,u))}},0)},this.deferred=[],this.listener=function(){function f(){$("[data-property]").each(function(f,s){var y=$(s),h=$(s).data("property"),a=$(s).data("servicename"),p=$(s).data("printproperty"),w=$(s).data("replicate"),b=$(s).data("callback"),k=$(s).data("ignoreall"),d=$(s).data("params"),v=$(s).data("async"),l,c;v==undefined&&(v=!0);l=new u(h,a,p,w,b,k,d,v,y);n.resolveByConvention?(c=o(h),c==undefined?(n.enableDebug&&console.warn("Resolve by convention failed for property "+h+" trying to resolve the service by default"),c=i(t.propertyServices,r,a)):(n.enableDebug&&console.warn("Resolve by convention succeded for property "+h),l.propertyRequest=e(l.propertyRequest))):c=i(t.propertyServices,r,a);c==undefined?(console.warn("Service undefined for property "+h),n.enableDebug&&console.info("Trying to get the service by convention for property "+h),c=o(h),c==undefined?(console.warn("Second try : Service undefined for property "+h),console.info("Seems like you have the convention resolver inactive and you dont have a data-servicename defined for this property ("+h+"), skipping.....")):(console.info("The convention resolver fixed the problem, but please check the code or enable the convention resolver in the options object"),l.propertyRequest=e(l.propertyRequest),t.buildAjaxObj(c.propertyServiceEndPoint,l,t.deferred))):t.buildAjaxObj(c.propertyServiceEndPoint,l,t.deferred)})}function s(){$("[data-iterate]").each(function(n,i){t.processContext(i,t.deferred,!1,!0)})}f();s();$.when.apply($,t.deferred).done(t.allDoneFunction)},n.autoStart&&t.listener(),f=function(n){return Object.assign(n)},this.buildAjaxIObj=function(n,i,r,u,e,o,s){var h={};o?s&&(console.log("And its parent has finished"),i!==""&&r.push($.ajax({url:i,data:h,beforeSend:function(i,r){e!=undefined&&t.callFunction(e,h,n,function(n){n&&(r.url=r.url+"/"+n.Id)})},error:function(){console.warn("Endpoint ("+i+") failed");return}}).done(function(i){var r=[];$.each(i,function(n,t){r.push(new f(t))});t.processTemplate(n,r,u);console.log("I had finished my job");t.lookForChilds(n,!0)}))):i!==""&&r.push($.ajax({url:i,data:h,beforeSend:function(i,r){e!=undefined&&t.callFunction(e,h,n,function(n){n&&(r.url=r.url+"/"+n.Id)})},statusCode:{500:function(){console.log("500 error on context");console.log(+n);console.log("Ierate value"+u)}},error:function(){console.warn("Endpoint ("+i+") failed");return}}).done(function(i){var r=[];$.each(i,function(n,t){r.push(new f(t))});t.processTemplate(n,r,u);t.lookForChilds(n,!0)}))},this.processTemplate=function(n,i,r){var e=n.html(),f;n.html("");n.append("<!--IterationContext for "+r+"-->");$.each(i,function(t){var i="<div data-identifier="+t+">";i+=e;i+="<\/div>";n.append(i)});f=$(n).find("[data-identifier]");f.each(function(n,f){var e=$(f).data("identifier"),o;t.setSectionIdToQueueElement(e,r);o=$(f).find("[data-iproperty]");o.each(function(n,f){var o=$(f).data("iproperty"),s=$(f).data("printproperty"),h=$(f).data("replicate"),c=$(f).data("callback"),l=$(f).data("ignoreall"),a=t.resolvePropertyValue(o,i[e]),v=$(f),y=new u(o,"",s,h,c,l,undefined,!0,v,r);t.bindDataOfIteration(y,a)})});n.append("<!--End of IterationContext for"+r+"-->")},this.bindDataOfIteration=function(n,i){n.callbackFunc?n.useFuncOnly?t.callFunction(n.callbackFunc,i,n.element):(t.bindData(n,i),t.callFunction(n.callbackFunc,i,n.element)):t.bindData(n,i)},this.resolvePropertyValue=function(t,i){var r;n.enableDebug&&console.log("Trying to resolve "+t+" from object -->");for(r in i)if(Object.prototype.hasOwnProperty.call(i,r)&&t===r)return i[r]},this.buildAjaxObj=function(n,i,r){if(n!==""&&i.propertyRequest!==""){var u=t.resolveDataRequest(i.propertyRequest,i.requestProperties);r.push($.ajax({url:n,data:u,async:i.runAsync}).done(function(n){i.callbackFunc?i.useFuncOnly?t.callFunction(i.callbackFunc,n,i.element):(t.bindData(i,u),t.callFunction(i.callbackFunc,n,i.element)):t.bindData(i,n)}))}},this.callFunction=function(n,t,i,r){try{window[n](t,i,function(n){r(n)})}catch(u){console.warn("Callback function has failed to execute or has some internal errors, please check it out --->");console.log("----------------------------------");console.log(u);console.log("----------------------------------");console.info("Dont try to eval the function in the lib source dude... pls -->");console.info("Lets continue....");return}},this.allDoneFunction=function(){n.onAllRequestsFinished?(n.onAllRequestsFinished(),n.useOverlay&&t.hideOverlay()):(n.useOverlay&&t.hideOverlay(),console.log("All requests done"))},this.hideOverlay=function(){n.overlayObj?document.getElementById(n.overlayObj).style.width="0%":console.warn("No overlay defined")},this.bindData=function(n,i){n.printInProperty?(n.element.attr(n.printInProperty,i),n.replicate?t.appendDataInDomElement(n,i):t.appendOnlyId(n)):t.appendDataInDomElement(n,i)},this.appendDataInDomElement=function(n,t){n.element.text(t);n.element.attr("id",n.propertyRequest);n.element.attr("data-finished",!0)},this.appendOnlyId=function(n){n.element.attr("id",n.propertyRequest);n.element.attr("data-finished",!0);t.executeInQueue(n.iterationObjName)},this.getValueFromDomElement=function(n){var t=document.getElementById(n).value;return t?t:undefined},this.getValue=function(n,u,f,e){var o=i(t.propertyServices,r,n);o==undefined?console.error("Service undefined"):t.getValueFromService(o,u,f,function(n){e(n)})},this.getValueFromService=function(n,i,r,u){var f=t.resolveDataRequest(i,r);$.ajax({url:n.propertyServiceEndPoint,data:f,success:function(n){u(n)}})},this.resolveDataRequest=function(t,i){var u={key:t},r;return i!=undefined?(r=h(u,i),n.enableDebug&&(console.info("The request object has been extended --->"),console.log(r)),r):u},{propertyServices:this.propertyServices,defineNewPropertyService:this.definePropertyService,defineIterationSericePoint:this.defineIterationService,getValueFromDom:this.getValueFromDomElement,startListener:this.listener,getValue:this.getValue}};